<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Profiles — Young ImaBio</title>
  <meta name="description" content="Sign in to access profiles"/>
  <link rel="icon" href="/uploads/favicon.ico"/>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container nav" role="navigation">
      <a class="brand" href="/">
        <span class="logo" aria-hidden="true"></span>
        Young ImaBio
      </a>
      <nav class="menu">
        <a href="/events/">Events</a>
        <a href="/team/">Team</a>
        <a class="active" href="/profiles/">Profiles</a>
        <a href="/join/">Join</a>
        <a href="/contact/">Contact</a>
      </nav>
    </div>
  </header>

  <main id="main" class="container section">
    <h1>Profiles</h1>
    <p class="lead">Sign in with a one‑time link to access member profiles. No password needed.</p>

    <!-- Signed OUT state -->
    <section id="signin-card" class="card" style="padding:1rem; display:block; max-width:520px">
      <form id="signin-form" onsubmit="return false" style="display:grid; gap:.75rem">
        <label>
          <span class="sr-only">Email</span>
          <input id="email" type="email" placeholder="you@example.com" required
                 style="width:100%; padding:.7rem; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.03); color:var(--text);">
        </label>
        <button id="send-link" class="btn" type="submit">Send me a login link</button>
        <p class="meta">We’ll email you a secure, one‑time link. Check your inbox (and spam). Links expire after a short time.</p>
      </form>
    </section>

    <!-- Signed IN state -->
    <section id="signedin-card" class="card" style="padding:1rem; display:none; max-width:620px">
      <p id="whoami" style="margin-top:0">You’re signed in.</p>
      <div style="display:flex; gap:.6rem; flex-wrap:wrap">
        <a class="btn" href="/profiles/edit/">Edit my profile</a>
        <a class="btn" href="/profiles/browse/">Browse members</a>
        <button id="signout" class="btn" type="button">Sign out</button>
      </div>
    </section>
  </main>

  <footer>
    <div class="container footer-grid">
      <small>© <span id="year"></span> Young ImaBio</small>
      <small style="justify-self:end">Made with ♥ by the team</small>
    </div>
  </footer>

  <!-- Firebase (compat) SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    // TODO: replace with your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCvF5L5TKBfe3MCe25_0dz-I61VID8rVXg",
      authDomain: "young-imabio-c7f74.firebaseapp.com",
      projectId: "young-imabio-c7f74",
      storageBucket: "young-imabio-c7f74.firebasestorage.app",
      messagingSenderId: "257415369612",
      appId: "1:257415369612:web:b08f3f0fa5828e0c0bfca9",
      measurementId: "G-D3R7WK86QD"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Helpers to toggle UI
    function showSignedIn(user){
      document.getElementById('signin-card').style.display = 'none';
      document.getElementById('signedin-card').style.display = 'block';
      const email = user && (user.email || (user.providerData[0] && user.providerData[0].email)) || '';
      document.getElementById('whoami').textContent = `You’re signed in as ${email}.`;
    }
    function showSignedOut(){
      document.getElementById('signedin-card').style.display = 'none';
      document.getElementById('signin-card').style.display = 'block';
    }

    // Year in footer
    document.getElementById('year').textContent = new Date().getFullYear();

    // 1) Handle incoming magic links
    (async function handleEmailLink(){
      try{
        const href = window.location.href;
        if (auth.isSignInWithEmailLink(href)){
          let email = window.localStorage.getItem('emailForSignIn');
          if (!email){
            email = window.prompt('Confirm your email to finish sign‑in:');
          }
          const { user } = await auth.signInWithEmailLink(email, href);
          window.localStorage.removeItem('emailForSignIn');
          showSignedIn(user);
        }
      } catch(err){
        console.error(err);
        alert(err.message || 'Could not complete sign‑in. Try sending a new link.');
      }
    })();

    // 2) Listen to auth state
    auth.onAuthStateChanged(user => {
      if (user) showSignedIn(user); else showSignedOut();
    });

    // 3) Send magic link
    document.getElementById('signin-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      if (!email) return;
      const actionCodeSettings = {
        url: window.location.origin + '/profiles/', // send them back here after click
        handleCodeInApp: true
      };
      try{
        await auth.sendSignInLinkToEmail(email, actionCodeSettings);
        window.localStorage.setItem('emailForSignIn', email);
        alert('Login link sent! Check your inbox.');
      } catch(err){
        console.error(err);
        alert(err.message || 'Could not send link.');
      }
    });

    // 4) Sign out
    document.getElementById('signout').addEventListener('click', async () => {
      await auth.signOut();
      showSignedOut();
    });
  </script>
</body>
</html>
