<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Profiles — Young ImaBio</title>
  <meta name="description" content="Sign in with email and password to access profiles"/>
  <link rel="icon" href="/uploads/favicon.ico"/>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <!-- Header -->
  <header>
    <div class="container nav" role="navigation">
      <a class="brand" href="/">
        <span class="logo" aria-hidden="true"></span>
        Young ImaBio
      </a>
      <nav class="menu">
        <a href="/events/">Events</a>
        <a href="/team/">Team</a>
        <a class="active" href="/profiles/">Profiles</a>
        <a href="/join/">Join</a>
        <a href="/contact/">Contact</a>
      </nav>
    </div>
  </header>

  <main id="main" class="container section">
    <h1>Profiles</h1>
    <p class="lead">Sign in with your email and password. If you were approved, you should have received a password‑reset link to set your password.</p>

    <!-- Signed OUT state -->
    <section id="signin-card" class="card" style="padding:1rem; display:block; max-width:520px">
      <form id="signin-form" onsubmit="return false" style="display:grid; gap:.75rem">
        <label>
          <span class="sr-only">Email</span>
          <input id="email" type="email" placeholder="you@example.com" required
                 style="width:100%; padding:.7rem; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.03); color:var(--text);">
        </label>
        <label>
          <span class="sr-only">Password</span>
          <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" required
                 style="width:100%; padding:.7rem; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.03); color:var(--text);">
        </label>
        <button id="signin" class="btn" type="submit">Sign in</button>
        <button id="reset" class="btn btn-secondary" type="button" style="justify-self:start">Forgot password?</button>
        <p class="meta" id="signin-help">No public sign‑ups. If you need access, please <a href="/join/">apply here</a>.</p>
        <p class="meta" id="status" role="status" aria-live="polite" style="min-height:1.2em"></p>
      </form>
    </section>

    <!-- Signed IN state -->
    <section id="signedin-card" class="card" style="padding:1rem; display:none; max-width:620px">
      <p id="whoami" style="margin-top:0">You’re signed in.</p>
      <div style="display:flex; gap:.6rem; flex-wrap:wrap">
        <a class="btn" href="/profiles/edit/">Edit my profile</a>
        <a class="btn" href="/profiles/browse/">Browse members</a>
        <button id="signout" class="btn" type="button">Sign out</button>
      </div>
    </section>
  </main>

  <footer>
    <div class="container footer-grid">
      <small>© <span id="year"></span> Young ImaBio</small>
      <small style="justify-self:end">Made with ♥ by the team</small>
    </div>
  </footer>

  <!-- Firebase (compat) SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script>
    // TODO: replace with your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCvF5L5TKBfe3MCe25_0dz-I61VID8rVXg",
      authDomain: "young-imabio-c7f74.firebaseapp.com",
      projectId: "young-imabio-c7f74",
      storageBucket: "young-imabio-c7f74.firebasestorage.app",
      messagingSenderId: "257415369612",
      appId: "1:257415369612:web:b08f3f0fa5828e0c0bfca9",
      measurementId: "G-D3R7WK86QD"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Helpers to toggle UI
    function showSignedIn(user){
      document.getElementById('signin-card').style.display = 'none';
      document.getElementById('signedin-card').style.display = 'block';
      const email = user && (user.email || (user.providerData[0] && user.providerData[0].email)) || '';
      document.getElementById('whoami').textContent = `You’re signed in as ${email}.`;
      setStatus('');
    }
    function showSignedOut(){
      document.getElementById('signedin-card').style.display = 'none';
      document.getElementById('signin-card').style.display = 'block';
    }
    function setStatus(msg){
      document.getElementById('status').textContent = msg || '';
    }

    // Year in footer
    document.getElementById('year').textContent = new Date().getFullYear();

    // Listen to auth state
    auth.onAuthStateChanged(user => {
      if (user) showSignedIn(user); else showSignedOut();
    });

    // Sign in with email + password (NO public sign up)
    document.getElementById('signin-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      if (!email || !password) return;
      setStatus('Signing in…');
      try{
        const { user } = await auth.signInWithEmailAndPassword(email, password);
        showSignedIn(user);
      } catch(err){
        console.error(err);
        // Friendly messages, without hinting whether the account exists
        switch (err.code) {
          case 'auth/user-not-found':
          case 'auth/wrong-password':
          case 'auth/invalid-credential':
            setStatus('Could not sign in. Check your email + password, or reset your password.');
            break;
          case 'auth/too-many-requests':
            setStatus('Too many attempts. Please try again later.');
            break;
          default:
            setStatus(err.message || 'Could not sign in.');
        }
      }
    });

    // Password reset (works only for existing accounts created by admins)
    document.getElementById('reset').addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      if (!email) { setStatus('Enter your email first.'); return; }
      setStatus('Sending reset email…');
      try{
        const actionCodeSettings = {
          url: window.location.origin + '/profiles/',
          handleCodeInApp: false
        };
        await auth.sendPasswordResetEmail(email, actionCodeSettings);
        setStatus('If an account exists for that email, a reset link has been sent.');
      } catch(err){
        console.error(err);
        // Keep messaging generic to avoid user enumeration
        setStatus('If an account exists for that email, a reset link has been sent.');
      }
    });

    // Sign out
    document.getElementById('signout').addEventListener('click', async () => {
      await auth.signOut();
      showSignedOut();
    });
  </script>
</body>
</html>
