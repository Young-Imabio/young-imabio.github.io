<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Edit Profile — Young ImaBio</title>
  <meta name="description" content="Edit your member profile"/>
  <link rel="icon" href="/uploads/favicon.ico"/>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <header>
    <div class="container nav" role="navigation">
      <a class="brand" href="/"><span class="logo" aria-hidden="true"></span>Young ImaBio</a>
      <nav class="menu">
        <a href="/events/">Events</a>
        <a href="/team/">Team</a>
        <a href="/profiles/">Profiles</a>
        <a class="active" href="/profiles/edit/">Edit</a>
        <a href="/profiles/browse/">Browse</a>
        <a href="/contact/">Contact</a>
      </nav>
    </div>
  </header>

  <main class="container section">
    <h1>Edit my profile</h1>
    <p class="lead">Signed‑in members can update their profile details here. Changes may be reviewed before appearing to others.</p>

    <!-- Shown when signed OUT -->
    <div id="signedout" class="card" style="padding:1rem; display:none; max-width:740px">
      <p>You need to sign in first.</p>
      <a class="btn" href="/profiles/">Go to sign‑in</a>
    </div>

    <!-- Shown when signed IN -->
    <form id="form" class="card" style="padding:1rem; display:none; max-width:740px">
      <div style="display:grid; gap:.8rem">
        <label>Name
          <input id="name" type="text" required style="width:100%; padding:.7rem; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.03); color:var(--text);">
        </label>
        <label>Bio
          <textarea id="bio" rows="6" placeholder="Short bio…" style="width:100%; padding:.7rem; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.03); color:var(--text);"></textarea>
        </label>
        <label>Tags (comma‑separated)
          <input id="tags" type="text" placeholder="microscopy, phd, france" style="width:100%; padding:.7rem; border-radius:12px; border:1px solid var(--border); background:rgba(255,255,255,.03); color:var(--text);">
        </label>
        <label style="display:flex; gap:.6rem; align-items:center">
          <input id="visibility" type="checkbox"> Visible to other members
        </label>
        <small class="meta">Note: new or edited profiles may require admin approval before they’re visible in Browse.</small>
        <div style="display:flex; gap:.6rem; flex-wrap:wrap">
          <button class="btn" type="submit">Save changes</button>
          <button id="signout" class="btn" type="button">Sign out</button>
        </div>
        <div id="status" class="meta"></div>
      </div>
    </form>
  </main>

  <footer>
    <div class="container footer-grid">
      <small>© <span id="year"></span> Young ImaBio</small>
      <small style="justify-self:end">Made with ♥ by the team</small>
    </div>
  </footer>

  <!-- Firebase SDKs (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script>
    // Replace with your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCvF5L5TKBfe3MCe25_0dz-I61VID8rVXg",
      authDomain: "young-imabio-c7f74.firebaseapp.com",
      projectId: "young-imabio-c7f74",
      storageBucket: "young-imabio-c7f74.firebasestorage.app",
      messagingSenderId: "257415369612",
      appId: "1:257415369612:web:b08f3f0fa5828e0c0bfca9",
      measurementId: "G-D3R7WK86QD"
    };
    firebase.initializeApp(firebaseConfig);

    const auth = firebase.auth();
    const db = firebase.firestore();

    const yearEl = document.getElementById('year');
    yearEl.textContent = new Date().getFullYear();

    const signedOut = document.getElementById('signedout');
    const form = document.getElementById('form');
    const statusEl = document.getElementById('status');

    function showOut(){ signedOut.style.display='block'; form.style.display='none'; }
    function showIn(){ signedOut.style.display='none'; form.style.display='block'; }

    // Auth state
    auth.onAuthStateChanged(async (user) => {
      if (!user) { showOut(); return; }
      showIn();
      document.getElementById('signout').onclick = () => auth.signOut();

      // Load existing profile
      const ref = db.collection('profiles').doc(user.uid);
      const snap = await ref.get();
      if (snap.exists) {
        const p = snap.data();
        document.getElementById('name').value = p.name || '';
        document.getElementById('bio').value = p.bio || '';
        document.getElementById('tags').value = (p.tags || []).join(', ');
        document.getElementById('visibility').checked = !!p.visibility;
      }

      // Save
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        statusEl.textContent = 'Saving…';
        const tags = document.getElementById('tags').value
          .split(',')
          .map(t => t.trim())
          .filter(Boolean)
          .map(t => t.toLowerCase());
        const data = {
          name: document.getElementById('name').value.trim(),
          bio: document.getElementById('bio').value.trim(),
          tags,
          visibility: document.getElementById('visibility').checked,
          approved: false, // stays false until you approve
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        // Use set({merge:true}) to avoid overwriting createdAt on updates
        await ref.set(data, { merge: true });
        statusEl.textContent = 'Saved. Awaiting approval if required.';
      }, { once: true });
    });
  </script>
</body>
</html>